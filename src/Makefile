## Licensed under the Apache License, Version 2.0 (the "License"); you may not
## use this file except in compliance with the License.  You may obtain a copy
## of the License at
##
##   http://www.apache.org/licenses/LICENSE-2.0
##
## Unless required by applicable law or agreed to in writing, software
## distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
## WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
## License for the specific language governing permissions and limitations
## under the License.
EMULATOR=beam
EBIN=$(ROOT)/ebin
INCLUDE=$(ROOT)/include

APP=$(EBIN)/kai.app
CONFIG=$(EBIN)/kai.config

ERL_COMPILE_FLAGS += \
	+warn_unused_vars +nowarn_shadow_vars +warn_unused_import \
	+debug_info

SOURCES = \
	kai_config kai_hash kai_store kai_version \
	kai_coordinator kai_sync kai_membership kai_sup kai \
	kai_tcp_server kai_api kai_memcache vclock

MODS = ${SOURCES:%=$(EBIN)/%.$(EMULATOR)} $(APP) $(CONFIG)

$(EBIN)/%.$(EMULATOR):%.erl
	erlc -pa $(EBIN) -W $(ERL_COMPILE_FLAGS) -I$(INCLUDE) -o$(EBIN) $<

all: $(MODS)

$(MODS): $(INCLUDE)/kai.hrl

dialyze:
	dialyzer --succ_typings -c ${SOURCES:%=%.erl}

clean:	
	rm -rf $(EBIN)/*.$(EMULATOR) $(APP) $(CONFIG) $(EBIN)/erl_crash.dump *~

$(APP): kai.app.src Makefile
	sed -e 's;%VSN%;$(KAI_VSN);' $< > $@

$(CONFIG): kai.config.src Makefile
	sed -e 's;%LOGS_DIR%;$(ROOT)/log;' $< > $@
